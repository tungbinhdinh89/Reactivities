#!/bin/bash

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# Ki·ªÉm tra BRANCH_NAME kh√¥ng r·ªóng v√† kh√¥ng ·ªü tr·∫°ng th√°i detached HEAD
if [ ! -z "$BRANCH_NAME" ] && [ "$BRANCH_NAME" != "HEAD" ] && [ "$SKIP_PREPARE_COMMIT_MSG" != 1 ]; then

  PREFIX_PATTERN='[A-Z]{1,5}-[0-9]{1,6}'  # T√¨m pattern d·∫°ng R-001
  
  if [[ $BRANCH_NAME =~ $PREFIX_PATTERN ]]; then
    PREFIX=${BASH_REMATCH[0]}  # L·∫•y ph·∫ßn match ƒë·∫ßu ti√™n
    echo "üîç PREFIX detected: $PREFIX"  # Debug log ki·ªÉm tra
    
    PREFIX_IN_COMMIT=$(grep -c "$PREFIX: " "$1")

    # N·∫øu PREFIX t·ªìn t·∫°i trong branch name v√† ch∆∞a c√≥ trong commit message
    if [[ -n "$PREFIX" ]] && [[ $PREFIX_IN_COMMIT -eq 0 ]]; then
      sed -i.bak -e "1s~^~$PREFIX: ~" "$1"
      echo "‚úÖ Added PREFIX '$PREFIX' to commit message."
    else
      echo "‚ö†Ô∏è PREFIX '$PREFIX' already exists in commit message. Skipping."
    fi
  else
    echo "‚ùå No PREFIX found in branch name: $BRANCH_NAME"
  fi

fi

